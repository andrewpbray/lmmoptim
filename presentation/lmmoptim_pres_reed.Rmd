---
title: "Branch, Bound, & Kill"
author: "Andrew Bray, UMass Amherst / Mount Holyoke / Reed College"
date: "April 30, 2015"
output:
  ioslides_presentation:
    mathjax: "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    logo: umass_seal.png
  runtime: shiny
---

```{r global-opts, echo = FALSE, message = FALSE}
#   runtime: shiny
library(knitr)
opts_chunk$set(echo = FALSE, cache = TRUE)
```

## While you're waiting . . . {.smaller}

48 male bank supervisors were asked to assume the role of the personnel director of a bank and were given a personnel file to judge whether the person should be promoted to a branch manager position. The files given to the participants were identical, except that half of them indicated the candidate was male and the other half indicated the candidate was female. These files were randomly assigned to the supervisiors. For each supervisor we recorded the gender associated with the assigned file and the promotion decision.

```{r table, message = FALSE, echo = FALSE}
tab <- data.frame(c(18, 14), c(6, 10), row.names = c("male", "female"))
```


|           |     promoted|     not promoted     |
|----------:|:-----------:|:--------------------:|
|male       |           18|          6           |
|female     |           14|          10          |

\
\

**Is this data consistent with the claim that females are unfairly discriminated against in promotion decisions? What statistical method would you use to make that determination?**

<!---
Adapted from: Rosen B and Jerdee T. 1974. ``Influence of sex role stereotypes on personnel decisions.'' Journal of Applied Psychology 59(1):9-14
-->


#

# Branch, Bound, & Kill

## Learning a function {.build}

> - Where is the function high? Low?
> - Steep? Flat?
> - How many modes?

$$
f(x) = 18x - 3x^2 \\
f'(x) = 18 - 6x \\
f''(x) = -6
$$

```{r echo=FALSE, eval=FALSE}
x <- seq(-15, 15, .01)
y <- 18 * x - 3 * x^2
plot(y ~ x, type = "l")
abline(v = 3, col = "goldenrod")
```

## Learning a function without Calculus

## Bound

```{r boundplot1}
library(shiny)
library(wesanderson)
library(dplyr)
COL <- wes_palette("Cavalcanti", 5)
COL[5] <- '#f03b20'
COL[4] <- '#bd0026'
d <- density(faithful$eruptions, adjust = .25)

branchNbound <- function(m, d, it, epsilon) {
  i <- 1
  repeat {
    names(m)[c(2, 3, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17)] <-
      names(m)[c(2, 3, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17)][c(2, 1, 5, 6, 3, 4, 9, 10, 7, 8, 12, 11, 15, 13, 14)]

    m <- m %>% group_by(membership_old) %>% # branch
      mutate(membership_new = ifelse(active_new,
                                     ifelse((membership_old - size) < ind & ind <= (membership_old - size/2),
                                            membership_old - size/2, membership_old), membership_old)) %>%
      mutate(size = ifelse(active_new, size/2, size)) %>%
      mutate(xmin_new = ifelse(membership_new == membership_old & active_new == 1, (xmax_old - xmin_old)/2 + xmin_old, xmin_old)) %>%
      mutate(xmax_new = ifelse(membership_new < membership_old & active_new == 1, (xmax_old - xmin_old)/2 + xmin_old, xmax_old)) %>%
      ungroup() %>%
      group_by(membership_new) %>% # bound
      mutate(L_new = min(d$y[xmin_new < d$x & d$x < xmax_new])) %>%
      mutate(U_new = max(d$y[xmin_new < d$x & d$x < xmax_new])) %>%
      mutate(envelope_new = U_new - L_new) %>% # kill
      mutate(active_newest = ifelse(envelope_new < epsilon, 0, 1)) %>%
      ungroup()

    i <- i + 1
    if (i > it) break
  }
  m
}

maxit <- 8
m <- data.frame("ind" = 1:2^maxit,
                    "membership_old" = rep(2^maxit, 2^maxit),
                    "membership_new" = rep(2^maxit, 2^maxit),
                    "size" = rep(2^maxit, 2^maxit),
                    "xmin_old" = rep(min(d$x), 2^maxit),
                    "xmax_old" = rep(max(d$x), 2^maxit),
                    "xmin_new" = rep(min(d$x), 2^maxit),
                    "xmax_new" = rep(max(d$x), 2^maxit),
                    "L_old" = rep(min(d$y), 2^maxit),
                    "U_old" = rep(max(d$y), 2^maxit),
                    "L_new" = rep(min(d$y), 2^maxit),
                    "U_new" = rep(max(d$y), 2^maxit),
                    "envelope_old" = rep(max(d$y) - min(d$y), 2^maxit),
                    "envelope_new" = rep(max(d$y) - min(d$y), 2^maxit),
                    "active_old" = rep(1, 2^maxit),
                    "active_new" = rep(1, 2^maxit),
                    "active_newest" = rep(1, 2^maxit))

plot(range(d$x), range(d$y), type = "n", xlab = "x", ylab = "f(x)",
     bty = "n", xaxp = c(1, 5.5, 10))
lines(d, col = COL[1], lwd = 3)

m2 <- branchNbound(m, d, it = 1, epsilon = .1)
```

## Bound

```{r boundplot2}
plot(range(d$x), range(d$y), type = "n", xlab = "x", ylab = "f(x)",
     bty = "n", xaxp = c(1, 5.5, 10))
lines(d, col = COL[1], lwd = 3)

segs <- unique(m2$membership_old)
for (i in segs) { # bound
      seg_row <- m2 %>% filter(membership_old == i) %>% slice(1)
      lines(c(seg_row$xmin_old, seg_row$xmax_old), rep(seg_row$L_old, 2), col = COL[2], lwd = 3)
      lines(c(seg_row$xmin_old, seg_row$xmax_old), rep(seg_row$U_old, 2), col = COL[2], lwd = 3)
}
```

## Kill?

```{r killplot1}
plot(range(d$x), range(d$y), type = "n", xlab = "x", ylab = "f(x)",
     bty = "n", xaxp = c(1, 5.5, 10))
lines(d, col = COL[1], lwd = 3)

segs <- unique(m2$membership_old)
for (i in segs) { # bound
      seg_row <- m2 %>% filter(membership_old == i) %>% slice(1)
      lines(c(seg_row$xmin_old, seg_row$xmax_old), rep(seg_row$L_old, 2), col = COL[2], lwd = 3)
      lines(c(seg_row$xmin_old, seg_row$xmax_old), rep(seg_row$U_old, 2), col = COL[2], lwd = 3)
}
```

## Kill?

```{r killplot2}
plot(range(d$x), range(d$y), type = "n", xlab = "x", ylab = "f(x)",
     bty = "n", xaxp = c(1, 5.5, 10))
lines(d, col = COL[1], lwd = 3)

segs <- unique(m2$membership_old)
for (i in segs) { # bound
      seg_row <- m2 %>% filter(membership_old == i) %>% slice(1)
      lines(c(seg_row$xmin_old, seg_row$xmax_old), rep(seg_row$L_old, 2), col = COL[2], lwd = 3)
      lines(c(seg_row$xmin_old, seg_row$xmax_old), rep(seg_row$U_old, 2), col = COL[2], lwd = 3)
}
lines(x = c(5.4, 5.4), y = c(.25, .35), lwd = 3, col = COL[4])
lines(x = c(5.35, 5.45), y = c(.25, .25), lwd = 3, col = COL[4])
lines(x = c(5.35, 5.45), y = c(.35, .35), lwd = 3, col = COL[4])
text(x = 5.48, y = .3, label = expression(epsilon), cex = 1.7)
```

## Branch

```{r branchplot}
plot(range(d$x), range(d$y), type = "n", xlab = "x", ylab = "f(x)",
     bty = "n", xaxp = c(1, 5.5, 10))
lines(d, col = COL[1], lwd = 3)

segs <- unique(m2$membership_old)
for (i in segs) { # bound
      seg_row <- m2 %>% filter(membership_old == i) %>% slice(1)
      lines(c(seg_row$xmin_old, seg_row$xmax_old), rep(seg_row$L_old, 2), col = COL[2], lwd = 3)
      lines(c(seg_row$xmin_old, seg_row$xmax_old), rep(seg_row$U_old, 2), col = COL[2], lwd = 3)
# branch
      seg_split <- m2$membership_new[!m2$membership_new == m2$membership_old]
      for(i in seg_split) {
        seg_row <- m2 %>% filter(membership_new == i) %>% slice(1)
        lines(rep(seg_row$xmax_new, 2), c(-.2, 1.05 * max(d$y)), lty = 2, col = "darkgrey", lwd = 2)
      }
}
```

## Bound

```{r branchboundplot}
plot(range(d$x), range(d$y), type = "n", xlab = "x", ylab = "f(x)",
     bty = "n", xaxp = c(1, 5.5, 10))
lines(d, col = COL[1], lwd = 3)

dit <- 4
m2 <- branchNbound(m, d, it = 2, epsilon = .2)
segs <- unique(m2$membership_old)

    for (i in segs) { # bound
      seg_row <- m2 %>% filter(membership_old == i) %>% slice(1)
      lines(c(seg_row$xmin_old, seg_row$xmax_old), rep(seg_row$L_old, 2), col = COL[2], lwd = 3)
      lines(c(seg_row$xmin_old, seg_row$xmax_old), rep(seg_row$U_old, 2), col = COL[2], lwd = 3)
      if(seg_row$active_old) {
        lines(rep(seg_row$xmax_old, 2), c(-.2, 1.05 * max(d$y)), lty = 2, col = "lightgrey", lwd = 2) # (old branch)
      }
      if (seg_row$active_old + seg_row$active_new == 0) { # (old kill)
        seg_row_end <- m2 %>% filter(membership_old == i) %>% slice(n())
        polygon(c(seg_row$xmin_old, seg_row_end$xmax_old, seg_row_end$xmax_old, seg_row$xmin_old),
                c(seg_row$L_old, seg_row$L_old, seg_row$U_old, seg_row$U_old),
                col = COL[4], border = NA)
      }
      if (dit %in% seq(2, 24, 3)) { # new kill
        if (seg_row$active_old + seg_row$active_new == 1) {
          seg_row_end <- m2 %>% filter(membership_old == i) %>% slice(n())
          polygon(c(seg_row$xmin_old, seg_row_end$xmax_old, seg_row_end$xmax_old, seg_row$xmin_old),
                  c(seg_row$L_old, seg_row$L_old, seg_row$U_old, seg_row$U_old),
                  col = COL[5], border = NA)
        }
      }
      if (dit %in% seq(3, 24, 3)) { # recent kill
        if (seg_row$active_old + seg_row$active_new == 1) {
          seg_row_end <- m2 %>% filter(membership_old == i) %>% slice(n())
          polygon(c(seg_row$xmin_old, seg_row_end$xmax_old, seg_row_end$xmax_old, seg_row$xmin_old),
                  c(seg_row$L_old, seg_row$L_old, seg_row$U_old, seg_row$U_old),
                  col = COL[4], border = NA)
        }
      }
    }

    if (dit %in% seq(3, 24, 3)) { # branch
      seg_split <- m2$membership_new[!m2$membership_new == m2$membership_old]
      for(i in seg_split) {
        seg_row <- m2 %>% filter(membership_new == i) %>% slice(1)
        lines(rep(seg_row$xmax_new, 2), c(-.2, 1.05 * max(d$y)), lty = 2, col = "darkgrey", lwd = 2)
      }
    }
```

## 

```{r bkk-app, cache = FALSE, echo = FALSE, message=FALSE, eval = TRUE}
library(shiny)
library(wesanderson)
library(dplyr)
COL <- wes_palette("Cavalcanti", 5)
COL[5] <- '#f03b20'
COL[4] <- '#bd0026'
d <- density(faithful$eruptions, adjust = .25)

branchNbound <- function(m, d, it, epsilon) {
  i <- 1
  repeat {
    names(m)[c(2, 3, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17)] <-
      names(m)[c(2, 3, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17)][c(2, 1, 5, 6, 3, 4, 9, 10, 7, 8, 12, 11, 15, 13, 14)]

    m <- m %>% group_by(membership_old) %>% # branch
      mutate(membership_new = ifelse(active_new,
                                     ifelse((membership_old - size) < ind & ind <= (membership_old - size/2),
                                            membership_old - size/2, membership_old), membership_old)) %>%
      mutate(size = ifelse(active_new, size/2, size)) %>%
      mutate(xmin_new = ifelse(membership_new == membership_old & active_new == 1, (xmax_old - xmin_old)/2 + xmin_old, xmin_old)) %>%
      mutate(xmax_new = ifelse(membership_new < membership_old & active_new == 1, (xmax_old - xmin_old)/2 + xmin_old, xmax_old)) %>%
      ungroup() %>%
      group_by(membership_new) %>% # bound
      mutate(L_new = min(d$y[xmin_new < d$x & d$x < xmax_new])) %>%
      mutate(U_new = max(d$y[xmin_new < d$x & d$x < xmax_new])) %>%
      mutate(envelope_new = U_new - L_new) %>% # kill
      mutate(active_newest = ifelse(envelope_new < epsilon, 0, 1)) %>%
      ungroup()

    i <- i + 1
    if (i > it) break
  }
  m
}


shinyApp(
  ui = fluidPage(fluidRow(plotOutput('bbplot', height = "400px")),
          fluidRow(style = "padding-bottom: 0px;",
                   column(2, numericInput("eps", label = "epsilon", value = .1, min = 0, max = .6, step = .1)),
                   column(2, numericInput("maxiter", label = "iterations", min = 1, max = 12, value = 8,
                                         step = 1)),
                   column(4, sliderInput("it", label = "stage", min = 1, max = 24, value = 1,
                                         step = 1, animate = animationOptions(loop = F, interval=2300))),
                   column(3, radioButtons("radio", label = "",
                                          choices = list("branch" = "option1", "bound" = "option2", "kill" = "option3"),
                                          selected = "option2"))
          )
),


  server = function(input, output, session) {
  observe({
    which_button <- c("option1", "option2", "option3")[(input$it %% 3) + 1]
    updateRadioButtons(session, "radio", selected = which_button)

    new_max <- input$maxiter * 3
    updateSliderInput(session, "it", max = new_max)
  })

  m <- reactive({
    maxit <- input$maxiter
    data.frame("ind" = 1:2^maxit,
                    "membership_old" = rep(2^maxit, 2^maxit),
                    "membership_new" = rep(2^maxit, 2^maxit),
                    "size" = rep(2^maxit, 2^maxit),
                    "xmin_old" = rep(min(d$x), 2^maxit),
                    "xmax_old" = rep(max(d$x), 2^maxit),
                    "xmin_new" = rep(min(d$x), 2^maxit),
                    "xmax_new" = rep(max(d$x), 2^maxit),
                    "L_old" = rep(min(d$y), 2^maxit),
                    "U_old" = rep(max(d$y), 2^maxit),
                    "L_new" = rep(min(d$y), 2^maxit),
                    "U_new" = rep(max(d$y), 2^maxit),
                    "envelope_old" = rep(max(d$y) - min(d$y), 2^maxit),
                    "envelope_new" = rep(max(d$y) - min(d$y), 2^maxit),
                    "active_old" = rep(1, 2^maxit),
                    "active_new" = rep(1, 2^maxit),
                    "active_newest" = rep(1, 2^maxit))
  })


  output$bbplot <- renderPlot({
    plot(range(d$x), range(d$y), type = "n", xlab = "x", ylab = "f(x)",
         bty = "n", xaxp = c(1, 5.5, 10))

    m2 <- branchNbound(m(), d, it = ceiling(input$it/3), epsilon = input$eps)
    segs <- unique(m2$membership_old)

    for (i in segs) { # bound
      seg_row <- m2 %>% filter(membership_old == i) %>% slice(1)
      lines(c(seg_row$xmin_old, seg_row$xmax_old), rep(seg_row$L_old, 2), col = COL[2], lwd = 3)
      lines(c(seg_row$xmin_old, seg_row$xmax_old), rep(seg_row$U_old, 2), col = COL[2], lwd = 3)
      if(seg_row$active_old) {
        lines(rep(seg_row$xmax_old, 2), c(-.2, 1.05 * max(d$y)), lty = 2, col = "lightgrey", lwd = 2) # (old branch)
      }
      if (seg_row$active_old + seg_row$active_new == 0) { # (old kill)
        seg_row_end <- m2 %>% filter(membership_old == i) %>% slice(n())
        polygon(c(seg_row$xmin_old, seg_row_end$xmax_old, seg_row_end$xmax_old, seg_row$xmin_old),
                c(seg_row$L_old, seg_row$L_old, seg_row$U_old, seg_row$U_old),
                col = COL[4], border = NA)
      }
      if (input$it %in% seq(2, 36, 3)) { # new kill
        if (seg_row$active_old + seg_row$active_new == 1) {
          seg_row_end <- m2 %>% filter(membership_old == i) %>% slice(n())
          polygon(c(seg_row$xmin_old, seg_row_end$xmax_old, seg_row_end$xmax_old, seg_row$xmin_old),
                  c(seg_row$L_old, seg_row$L_old, seg_row$U_old, seg_row$U_old),
                  col = COL[5], border = NA)
        }
      }
      if (input$it %in% seq(3, 36, 3)) { # recent kill
        if (seg_row$active_old + seg_row$active_new == 1) {
          seg_row_end <- m2 %>% filter(membership_old == i) %>% slice(n())
          polygon(c(seg_row$xmin_old, seg_row_end$xmax_old, seg_row_end$xmax_old, seg_row$xmin_old),
                  c(seg_row$L_old, seg_row$L_old, seg_row$U_old, seg_row$U_old),
                  col = COL[4], border = NA)
        }
      }
    }
    #lines(d, col = COL[1], lwd = 3)

    if (input$it %in% seq(3, 36, 3)) { # branch
      seg_split <- m2$membership_new[!m2$membership_new == m2$membership_old]
      for(i in seg_split) {
        seg_row <- m2 %>% filter(membership_new == i) %>% slice(1)
        lines(rep(seg_row$xmax_new, 2), c(-.2, 1.05 * max(d$y)), lty = 2, col = "darkgrey", lwd = 2)
      }
    }

  })
  }
)
```

## An Algorithm{.build}

To evaluate $f$ arbitrarily well everywhere within $B$,

> 1. Specify $\epsilon$.
> 2. For every active bin $b$
>  - calculate $U^b - L^b$
>  - if $U^b - L^b < \epsilon$, kill $b$
>  - else branch $b$ into two $b$s and repeat (2).

#

# The Likelihood Function

## While you're waiting . . . {.smaller}

48 male bank supervisors were asked to assume the role of the personnel director of a bank and were given a personnel file to judge whether the person should be promoted to a branch manager position. The files given to the participants were identical, except that half of them indicated the candidate was male and the other half indicated the candidate was female. These files were randomly assigned to the supervisiors. For each supervisor we recorded the gender associated with the assigned file and the promotion decision.

|           |     promoted|     not promoted     |
|----------:|:-----------:|:--------------------:|
|male       |           18|          6           |
|female     |           14|          10          |

\
\

**Is this data consistent with the claim that females are unfairly discriminated against in promotion decisions? What statistical method would you use to make that determination?**

## A model for promotion {.build}

|       | promoted  | not promoted | p(promoted) |
|------:|:---------:|:------------:|:-----------:|
|male   |     18    |      6       | 18/24 = .75 |
|female |     14    |      10      | 14/24 = .58 |

\

Suppose:

1. Each decision was independent.
2. All males were promoted with the same probability $p_{M}$.
3. All females were promoted with the same probability $p_{F}$.

$$
Y \sim \textrm{binomial}(n = 24, p = p_{M}) \\
X \sim \textrm{binomial}(n = 24, p = p_{F})
$$

## From Probability to Likelihood {.build .flexbox .vcenter}

$$
P(\color{red}{y}, \color{red}{x} | n, p_M, p_F) = {n \choose \color{red}{y}} p_M^\color{red}{y} (1 - p_M)^{n-\color{red}{y}} {n \choose \color{red}{x}} p_F^\color{red}{x} (1 - p_F)^{n-\color{red}{x}}
$$

\

vs.

\

$$
L(\color{red}{p_M}, \color{red}{p_F} | n, y, x) = {n \choose y} \color{red}{p_M}^y (1 - \color{red}{p_M})^{n-y} {n \choose x} \color{red}{p_F}^x (1 - \color{red}{p_F})^{n-x}
$$

## The Likelihood Function

```{r, echo = FALSE, fig.align='center', fig.height=4.5, fig.width=5.9, cache = TRUE}
pPromote <- seq(0, 1, .01)
Lfn <- function(pYgM, pYgF, tab, loglik = TRUE) {
  lik <- dbinom(tab[1, 1], rowSums(tab)[1], pYgM) * dbinom(tab[2, 1], rowSums(tab)[2], pYgF)
  if (loglik) {
    return(log(lik))
  } else {return(lik)}
  }
lik <- outer(pPromote, pPromote, tab = tab, FUN = Lfn, loglik = FALSE)

# plot surface in original coordinates
library(ggplot2); library(RColorBrewer)
mypal <- colorRampPalette(brewer.pal(9 , "OrRd"))
xyz <- data.frame(x = rep(pPromote, length(pPromote)),
                    y = rep(pPromote, each = length(pPromote)),
                    z = c(lik))
xyz$zbinned <- cut(xyz$z, breaks = 9)
p <- ggplot(xyz) + aes(x = x, y = y, fill = zbinned) +
  geom_tile() +
  scale_fill_manual(values = mypal(9), labels = c("low", "", "", "",
                           "medium", "", "", "", "high"),
                    guide = guide_legend(reverse=TRUE)) +
  labs(x = expression(p[male]), y = expression(p[female]), fill = "Likelihood") +
  theme_bw()
p
```

## The Likelihood Function

```{r, echo = FALSE, fig.align='center', fig.height=4.5, fig.width=5.9, cache = TRUE}
p + geom_abline(intercept = 0, slope = 1, lwd = 10, 
             color = "cadetblue", alpha = .4)
```

## Likelihood Function, more data

```{r, echo = FALSE, fig.align='center', fig.height=4.5, fig.width=5.9, cache = TRUE}
tab5 <- tab * 5
xyz$z5 <- c(outer(pPromote, pPromote, tab = tab5, FUN = Lfn, loglik = FALSE))
xyz$z5binned <- cut(xyz$z5, breaks = 9)
p <- ggplot(xyz) + aes(x = x, y = y, fill = z5binned) +
  geom_tile() +
  scale_fill_manual(values = mypal(9), labels = c("low", "", "", "",
                           "medium", "", "", "", "high"),
                    guide = guide_legend(reverse=TRUE)) +
  labs(x = expression(p[male]), y = expression(p[female]), fill = "Likelihood") +
  theme_bw()
p + geom_abline(intercept = 0, slope = 1, lwd = 10,
             color = "cadetblue", alpha = .4)
```

## Likelihood Function, even more data

```{r, echo = FALSE, fig.align='center', fig.height=4.5, fig.width=5.9, cache = TRUE}
tab12 <- tab * 12
xyz$z12 <- c(outer(pPromote, pPromote, tab = tab12, FUN = Lfn, loglik = FALSE))
xyz$z12binned <- cut(xyz$z12, breaks = 9)
p <- ggplot(xyz) + aes(x = x, y = y, fill = z12binned) +
  geom_tile() +
  scale_fill_manual(values = mypal(9), labels = c("low", "", "", "",
                           "medium", "", "", "", "high"),
                    guide = guide_legend(reverse=TRUE)) +
  labs(x = expression(p[male]), y = expression(p[female]), fill = "Likelihood") +
  theme_bw()
p + geom_abline(intercept = 0, slope = 1, lwd = 10,
             color = "cadetblue", alpha = .4)
```

#
# Branch, Bound, & Kill the Likelihood
